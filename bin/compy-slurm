#!/usr/bin/env bash

if [[ "$#" -lt 1 ]]; then
  echo "usage: compy-slurm COMPY_REVISION command [args...]"
  echo ""
  echo "Runs command on a slurm cluster, with the given git version of compy installed"
  exit 2
fi

export COMPY_REV="$1"
shift

# build compy if not in cache
export COMPY_WHEEL="$CACHE_ROOT/ComPy-$COMPY_REV-$WHEEL_COMPAT.whl"
if [[ ! -f "$COMPY_WHEEL" ]]; then
  env COMPY_WHEEL="" srun "${SLURM_ARGS[@]}" -n1 -c8 --mem=32G "$EXPERIMENTS_ROOT/run" \
   "$ENV_NAME"-slurm python "$EXPERIMENTS_ROOT/tasks/build-compy.py" "$COMPY_REV" "$(dirname "$COMPY_WHEEL")"
fi

# run batch job
sbatch "${SLURM_ARGS[@]}" "$EXPERIMENTS_ROOT/run" "$ENV_NAME"-slurm "$@"